import { useState, useEffect } from "react";
import {
  FiSearch,
  FiMapPin,
  FiStar,
  FiClock,
  FiUsers,
  FiDollarSign,
  FiFilter,
  FiChevronDown,
  FiActivity,
  FiCheck,
  FiArrowLeft,
  FiArrowRight,
  FiHeart,
  FiCalendar,
  FiAward,
  FiPhone,
  FiMail,
  FiGlobe,
  FiInstagram,
  FiUser,
  FiRefreshCw,
  FiAlertCircle,
  FiNavigation,
  FiX,
  FiImage,
} from "react-icons/fi";
import { Link } from "react-router-dom";
import axios from "axios";
import MapComponent from "../components/MapComponent";

// GymDetails Component to handle the expanded section
function GymDetails({ gym }) {
  const [currentImageIndex, setCurrentImageIndex] = useState(0);

  const nextImage = () => {
    if (gym.images && gym.images.length > 0) {
      setCurrentImageIndex((prev) => (prev + 1) % gym.images.length);
    }
  };

  const prevImage = () => {
    if (gym.images && gym.images.length > 0) {
      setCurrentImageIndex(
        (prev) => (prev - 1 + gym.images.length) % gym.images.length
      );
    }
  };

  const formatOperatingHours = (operatingHours) => {
    if (!operatingHours) return "Hours not specified";
    
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    const todayHours = operatingHours[today];
    
    if (todayHours?.closed) return "Closed today";
    if (todayHours?.open && todayHours?.close) {
      return `Open today: ${todayHours.open} - ${todayHours.close}`;
    }
    return "Hours not specified";
  };

  return (
    <div className="border-t border-gray-700/50 bg-gradient-to-br from-gray-800/60 via-gray-800/40 to-gray-900/60 backdrop-blur-xl relative overflow-hidden">
      {/* Background Animation */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute -top-4 -right-4 w-32 h-32 bg-violet-500/5 rounded-full blur-2xl animate-pulse"></div>
        <div className="absolute -bottom-4 -left-4 w-40 h-40 bg-indigo-500/5 rounded-full blur-2xl animate-pulse" style={{animationDelay: '1s'}}></div>
      </div>
      
      <div className="relative p-8">
        {/* Enhanced Header with Gym Logo */}
        <div className="text-center mb-10">
          <div className="flex flex-col items-center space-y-4">
            {gym.logo?.url && (
              <div className="relative group">
                <div className="absolute inset-0 bg-gradient-to-r from-violet-600/20 to-indigo-600/20 rounded-2xl blur-xl group-hover:blur-2xl transition-all duration-500"></div>
                <div className="relative bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 shadow-2xl transform hover:scale-105 transition-all duration-300">
                  <img
                    src={gym.logo.url}
                    alt={`${gym.gymName} Logo`}
                    className="h-24 w-auto mx-auto object-contain filter drop-shadow-2xl"
                  />
                </div>
                <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                  <div className="bg-gradient-to-r from-violet-500 to-indigo-500 text-white px-3 py-1 rounded-full text-xs font-medium shadow-lg">
                    Official Logo
                  </div>
                </div>
              </div>
            )}
            
            <div className="text-center">
              <h2 className="text-3xl font-bold bg-gradient-to-r from-violet-400 via-purple-400 to-indigo-400 bg-clip-text text-transparent mb-2">
                {gym.gymName}
              </h2>
              <div className="flex items-center justify-center space-x-2 text-gray-400">
                <FiMapPin className="w-4 h-4" />
                <span>{gym.address?.street}, {gym.address?.city}</span>
              </div>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
          {/* Enhanced About Section */}
          <div className="space-y-6">
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-4">
                <div className="w-10 h-10 bg-gradient-to-r from-violet-500 to-indigo-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiUser className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">
                  About {gym.gymName}
                </h4>
              </div>
              <p className="text-gray-300 leading-relaxed">{gym.description}</p>
            </div>
            
            {/* Enhanced Contact Information */}
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiPhone className="w-5 h-5 text-white" />
                </div>
                <h5 className="text-xl font-bold text-white">Contact Information</h5>
              </div>
              <div className="space-y-4">
                {gym.contactInfo?.phone && (
                  <div className="flex items-center p-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors">
                    <div className="w-8 h-8 bg-violet-500/20 rounded-lg flex items-center justify-center mr-3">
                      <FiPhone className="w-4 h-4 text-violet-400" />
                    </div>
                    <span className="text-gray-300">{gym.contactInfo.phone}</span>
                  </div>
                )}
                {gym.contactInfo?.email && (
                  <div className="flex items-center p-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors">
                    <div className="w-8 h-8 bg-violet-500/20 rounded-lg flex items-center justify-center mr-3">
                      <FiMail className="w-4 h-4 text-violet-400" />
                    </div>
                    <span className="text-gray-300">{gym.contactInfo.email}</span>
                  </div>
                )}
                {gym.contactInfo?.website && (
                  <div className="flex items-center p-3 bg-white/5 rounded-xl hover:bg-white/10 transition-colors">
                    <div className="w-8 h-8 bg-violet-500/20 rounded-lg flex items-center justify-center mr-3">
                      <FiGlobe className="w-4 h-4 text-violet-400" />
                    </div>
                    <a
                      href={gym.contactInfo.website}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-gray-300 hover:text-violet-400 transition-colors"
                    >
                      {gym.contactInfo.website.replace(/^https?:\/\//, "")}
                    </a>
                  </div>
                )}
              </div>
            </div>

            {/* Enhanced Address */}
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiMapPin className="w-5 h-5 text-white" />
                </div>
                <h5 className="text-xl font-bold text-white">Address</h5>
              </div>
              <div className="bg-white/5 rounded-xl p-4">
                <div className="text-gray-300 space-y-1">
                  <p className="font-medium">{gym.address?.street}</p>
                  <p>{gym.address?.city}, {gym.address?.state} {gym.address?.zipCode}</p>
                  <p>{gym.address?.country}</p>
                </div>
              </div>
            </div>

            {/* Enhanced Social Media */}
            {gym.socialMedia && Object.values(gym.socialMedia).some(val => val) && (
              <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
                <div className="flex items-center mb-6">
                  <div className="w-10 h-10 bg-gradient-to-r from-pink-500 to-rose-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                    <FiInstagram className="w-5 h-5 text-white" />
                  </div>
                  <h5 className="text-xl font-bold text-white">Follow Us</h5>
                </div>
                <div className="grid grid-cols-2 gap-3">
                  {Object.entries(gym.socialMedia).map(([platform, url]) => 
                    url ? (
                      <a
                        key={platform}
                        href={url}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center p-3 bg-white/5 text-gray-300 rounded-xl hover:bg-gradient-to-r hover:from-violet-500/20 hover:to-indigo-500/20 hover:text-white transition-all duration-300 text-sm group/social"
                      >
                        <FiInstagram className="w-4 h-4 mr-2 group-hover/social:scale-110 transition-transform duration-300" />
                        <span className="capitalize">{platform}</span>
                      </a>
                    ) : null
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Enhanced Operating Hours & Additional Info */}
          <div className="space-y-6">
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiClock className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Operating Hours</h4>
              </div>
              
              {gym.operatingHours ? (
                <div className="space-y-3">
                  {Object.entries(gym.operatingHours).map(([day, hours]) => (
                    <div key={day} className="group/day">
                      <div className="flex justify-between items-center bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-300 border border-transparent hover:border-violet-500/20">
                        <div className="flex items-center">
                          <div className="w-8 h-8 bg-gradient-to-r from-violet-500/20 to-indigo-500/20 rounded-lg flex items-center justify-center mr-3 group-hover/day:scale-110 transition-transform duration-300">
                            <FiCalendar className="w-4 h-4 text-violet-400" />
                          </div>
                          <span className="text-white capitalize font-medium">{day}</span>
                        </div>
                        <div className="text-right">
                          <span className={`font-semibold ${hours?.closed ? 'text-red-400' : 'text-green-400'}`}>
                            {hours?.closed ? 'Closed' : 
                             hours?.open && hours?.close ? `${hours.open} - ${hours.close}` : 'Not set'}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div className="text-center py-8 bg-white/5 rounded-xl">
                  <FiClock className="w-12 h-12 text-gray-500 mx-auto mb-2" />
                  <p className="text-gray-400">Operating hours not specified</p>
                </div>
              )}
            </div>

            {/* Enhanced Membership Plans */}
            {gym.pricing?.membershipPlans && gym.pricing.membershipPlans.length > 0 && (
              <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
                <div className="flex items-center mb-6">
                  <div className="w-10 h-10 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                    <FiDollarSign className="w-5 h-5 text-white" />
                  </div>
                  <h5 className="text-xl font-bold text-white">Membership Plans</h5>
                </div>
                <div className="space-y-4">
                  {gym.pricing.membershipPlans.map((plan, index) => (
                    <div key={index} className="group/plan relative overflow-hidden">
                      <div className="absolute inset-0 bg-gradient-to-r from-violet-500/5 to-indigo-500/5 rounded-xl opacity-0 group-hover/plan:opacity-100 transition-opacity duration-300"></div>
                      <div className="relative bg-white/5 rounded-xl p-5 border border-white/10 hover:border-violet-500/30 transition-all duration-300">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center">
                            <div className="w-8 h-8 bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-lg flex items-center justify-center mr-3 group-hover/plan:scale-110 transition-transform duration-300">
                              <FiAward className="w-4 h-4 text-green-400" />
                            </div>
                            <h6 className="text-white font-bold text-lg">{plan.name}</h6>
                          </div>
                          <div className="text-right">
                            <div className="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-3 py-1 rounded-full font-bold shadow-lg">
                              Rs. {plan.price}
                            </div>
                            <div className="text-gray-400 text-sm mt-1 capitalize">{plan.duration}</div>
                          </div>
                        </div>
                        {plan.benefits && plan.benefits.length > 0 && (
                          <div className="bg-white/5 rounded-lg p-3 mt-3">
                            <ul className="text-gray-300 text-sm space-y-2">
                              {plan.benefits.slice(0, 3).map((benefit, idx) => (
                                <li key={idx} className="flex items-center group/benefit">
                                  <div className="w-5 h-5 bg-green-500/20 rounded-full flex items-center justify-center mr-3 group-hover/benefit:scale-110 transition-transform duration-300">
                                    <FiCheck className="w-3 h-3 text-green-400" />
                                  </div>
                                  <span>{benefit}</span>
                                </li>
                              ))}
                            </ul>
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Enhanced Facilities & Services */}
      <div className="mt-10 space-y-8">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {gym.facilities && gym.facilities.length > 0 && (
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiActivity className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Facilities</h4>
              </div>
              <div className="grid grid-cols-2 gap-3">
                {gym.facilities.map((facility, index) => (
                  <div 
                    key={index}
                    className="group/facility bg-gradient-to-r from-blue-500/10 to-cyan-500/10 border border-blue-500/20 text-blue-300 rounded-xl p-3 text-sm text-center hover:from-blue-500/20 hover:to-cyan-500/20 hover:border-blue-400/40 transition-all duration-300 cursor-default"
                  >
                    <div className="flex items-center justify-center space-x-2">
                      <div className="w-6 h-6 bg-blue-500/20 rounded-lg flex items-center justify-center group-hover/facility:scale-110 transition-transform duration-300">
                        <FiCheck className="w-3 h-3 text-blue-400" />
                      </div>
                      <span className="font-medium">{facility}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {gym.services && gym.services.length > 0 && (
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiHeart className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Services</h4>
              </div>
              <div className="grid grid-cols-2 gap-3">
                {gym.services.map((service, index) => (
                  <div 
                    key={index}
                    className="group/service bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/20 text-green-300 rounded-xl p-3 text-sm text-center hover:from-green-500/20 hover:to-emerald-500/20 hover:border-green-400/40 transition-all duration-300 cursor-default"
                  >
                    <div className="flex items-center justify-center space-x-2">
                      <div className="w-6 h-6 bg-green-500/20 rounded-lg flex items-center justify-center group-hover/service:scale-110 transition-transform duration-300">
                        <FiCheck className="w-3 h-3 text-green-400" />
                      </div>
                      <span className="font-medium">{service}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

          {/* Enhanced Amenities */}
          {gym.amenities && gym.amenities.length > 0 && (
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiStar className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Amenities</h4>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {gym.amenities.map((amenity, index) => (
                  <div 
                    key={index}
                    className="group/amenity bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 text-purple-300 rounded-xl p-3 text-sm text-center hover:from-purple-500/20 hover:to-pink-500/20 hover:border-purple-400/40 transition-all duration-300 cursor-default"
                  >
                    <div className="flex items-center justify-center space-x-2">
                      <div className="w-6 h-6 bg-purple-500/20 rounded-lg flex items-center justify-center group-hover/amenity:scale-110 transition-transform duration-300">
                        <FiCheck className="w-3 h-3 text-purple-400" />
                      </div>
                      <span className="font-medium">{amenity}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Enhanced Equipment */}
          {gym.equipment && gym.equipment.length > 0 && (
            <div className="bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
              <div className="flex items-center mb-6">
                <div className="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiActivity className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Equipment</h4>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {gym.equipment.map((item, index) => (
                  <div key={index} className="group/equipment bg-white/5 rounded-xl p-4 border border-white/10 hover:border-orange-500/30 hover:bg-white/10 transition-all duration-300">
                    <div className="flex items-start space-x-3">
                      <div className="w-8 h-8 bg-gradient-to-r from-orange-500/20 to-red-500/20 rounded-lg flex items-center justify-center group-hover/equipment:scale-110 transition-transform duration-300">
                        <FiActivity className="w-4 h-4 text-orange-400" />
                      </div>
                      <div className="flex-1">
                        <p className="text-white font-bold text-lg mb-2">{item.name}</p>
                        <div className="space-y-1">
                          <div className="flex items-center space-x-4 text-sm">
                            <span className="text-gray-400">Quantity:</span>
                            <span className="bg-violet-500/20 text-violet-300 px-2 py-1 rounded-full font-medium">
                              {item.quantity || 1}
                            </span>
                          </div>
                          <div className="flex items-center space-x-4 text-sm">
                            <span className="text-gray-400">Condition:</span>
                            <span className={`px-2 py-1 rounded-full font-medium capitalize ${
                              item.condition === 'excellent' ? 'bg-green-500/20 text-green-300' :
                              item.condition === 'good' ? 'bg-blue-500/20 text-blue-300' :
                              item.condition === 'fair' ? 'bg-yellow-500/20 text-yellow-300' :
                              'bg-gray-500/20 text-gray-300'
                            }`}>
                              {item.condition || 'good'}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Enhanced Image Gallery */}
        {gym.images && gym.images.length > 0 && (
          <div className="mt-12 bg-white/5 backdrop-blur-sm rounded-2xl p-6 border border-white/10 hover:border-violet-500/30 transition-all duration-300 group">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center">
                <div className="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center mr-3 group-hover:scale-110 transition-transform duration-300">
                  <FiImage className="w-5 h-5 text-white" />
                </div>
                <h4 className="text-xl font-bold text-white">Photo Gallery</h4>
              </div>
              <div className="flex items-center space-x-3">
                <div className="bg-gradient-to-r from-violet-500 to-indigo-500 text-white px-4 py-2 rounded-full font-medium shadow-lg">
                  {currentImageIndex + 1} of {gym.images.length}
                </div>
              </div>
            </div>
            
            <div className="relative rounded-2xl overflow-hidden bg-black/20 backdrop-blur-sm border border-white/10 group/gallery shadow-2xl">
              <div className="absolute inset-0 bg-gradient-to-r from-violet-600/10 to-indigo-600/10 opacity-0 group-hover/gallery:opacity-100 transition-opacity duration-500"></div>
              <img
                src={gym.images[currentImageIndex].url}
                alt={gym.images[currentImageIndex].caption || `Gym image ${currentImageIndex + 1}`}
                className="w-full h-96 object-cover transform group-hover/gallery:scale-105 transition-transform duration-700"
              />
              
              {gym.images.length > 1 && (
                <>
                  <button
                    onClick={prevImage}
                    className="absolute left-6 top-1/2 -translate-y-1/2 bg-black/70 backdrop-blur-md p-4 rounded-full text-white hover:bg-black/90 hover:scale-110 transition-all duration-300 border border-white/30 shadow-xl opacity-0 group-hover/gallery:opacity-100"
                  >
                    <FiArrowLeft className="w-6 h-6" />
                  </button>
                  <button
                    onClick={nextImage}
                    className="absolute right-6 top-1/2 -translate-y-1/2 bg-black/70 backdrop-blur-md p-4 rounded-full text-white hover:bg-black/90 hover:scale-110 transition-all duration-300 border border-white/30 shadow-xl opacity-0 group-hover/gallery:opacity-100"
                  >
                    <FiArrowRight className="w-6 h-6" />
                  </button>
                </>
              )}
              
              {gym.images[currentImageIndex].caption && (
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-6">
                  <p className="text-white font-medium text-lg">{gym.images[currentImageIndex].caption}</p>
                </div>
              )}
              
              {/* Enhanced Image info overlay */}
              <div className="absolute top-6 right-6 flex space-x-2">
                {gym.images[currentImageIndex].isPrimary && (
                  <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium shadow-lg flex items-center">
                    <FiStar className="w-4 h-4 mr-1" />
                    Primary Photo
                  </div>
                )}
                <div className="bg-black/70 backdrop-blur-md text-white px-3 py-1 rounded-full text-sm font-medium border border-white/20">
                  High Quality
                </div>
              </div>
            </div>
            
            {/* Enhanced Thumbnail navigation */}
            {gym.images.length > 1 && (
              <div className="mt-6">
                <div className="flex space-x-4 overflow-x-auto pb-2 scrollbar-hide">
                  {gym.images.map((image, index) => (
                    <button
                      key={index}
                      onClick={() => setCurrentImageIndex(index)}
                      className={`relative flex-shrink-0 w-24 h-24 rounded-xl overflow-hidden border-2 transition-all duration-300 group/thumb ${
                        currentImageIndex === index 
                          ? 'border-violet-500 ring-4 ring-violet-500/30 scale-110 shadow-xl' 
                          : 'border-white/20 hover:border-violet-400/60 hover:scale-105'
                      }`}
                    >
                      <img
                        src={image.url}
                        alt={`Thumbnail ${index + 1}`}
                        className="w-full h-full object-cover transform group-hover/thumb:scale-110 transition-transform duration-300"
                      />
                      {image.isPrimary && (
                        <div className="absolute top-1 right-1 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full p-1 shadow-lg">
                          <FiStar className="w-3 h-3 text-white" />
                        </div>
                      )}
                      {currentImageIndex === index && (
                        <div className="absolute inset-0 bg-violet-500/20 flex items-center justify-center">
                          <div className="w-6 h-6 bg-violet-500 rounded-full flex items-center justify-center">
                            <FiCheck className="w-4 h-4 text-white" />
                          </div>
                        </div>
                      )}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Enhanced No Images Message */}
        {(!gym.images || gym.images.length === 0) && (
          <div className="mt-12 bg-white/5 backdrop-blur-sm rounded-2xl p-8 border border-white/10 text-center group hover:border-violet-500/30 transition-all duration-300">
            <div className="w-20 h-20 bg-gradient-to-r from-gray-600/20 to-gray-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform duration-300">
              <FiImage className="w-10 h-10 text-gray-400" />
            </div>
            <h4 className="text-xl font-bold text-gray-300 mb-2">
              ðŸ“¸ No Photos Available Yet
            </h4>
            <p className="text-gray-400 max-w-md mx-auto">
              Photos will be displayed here once uploaded by the gym owner. Check back soon for stunning images of this gym!
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

function FindGym() {
  const [searchTerm, setSearchTerm] = useState("");
  const [gyms, setGyms] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedFilters, setSelectedFilters] = useState({
    amenities: [],
    priceRange: "all",
    rating: "all",
    distance: "all",
    facilities: [],
    services: [],
  });
  const [location, setLocation] = useState({
    lat: 6.9271, // Colombo, Sri Lanka coordinates
    lng: 79.8612,
  });
  const [locationLoading, setLocationLoading] = useState(true);
  const [locationError, setLocationError] = useState(null);
  const [locationMethod, setLocationMethod] = useState('default'); // 'default', 'gps', 'manual'
  const [selectedGym, setSelectedGym] = useState(null);
  const [showManualLocationModal, setShowManualLocationModal] = useState(false);
  const [manualLocationInput, setManualLocationInput] = useState({ lat: '', lng: '' });
  const [nearestGymId, setNearestGymId] = useState(null);
  const [locationAccuracy, setLocationAccuracy] = useState(null);
  const [permissionStatus, setPermissionStatus] = useState('checking');

  // Dynamic filter options based on actual data
  const [amenityOptions, setAmenityOptions] = useState([]);
  const [facilityOptions, setFacilityOptions] = useState([]);
  const [serviceOptions, setServiceOptions] = useState([]);

  const priceRangeOptions = [
    { value: "all", label: "All Prices" },
    { value: "budget", label: "Budget (Under Rs. 3,000)" },
    { value: "standard", label: "Standard (Rs. 3,000 - 5,000)" },
    { value: "premium", label: "Premium (Above Rs. 5,000)" },
  ];

  const ratingOptions = [
    { value: "all", label: "All Ratings" },
    { value: "4.5", label: "4.5+ Stars" },
    { value: "4.0", label: "4.0+ Stars" },
    { value: "3.5", label: "3.5+ Stars" },
  ];

  const distanceOptions = [
    { value: "all", label: "All Distances" },
    { value: "5", label: "Within 5 km" },
    { value: "10", label: "Within 10 km" },
    { value: "25", label: "Within 25 km" },
  ];

  // Fetch gyms from API
  const fetchGyms = async () => {
    try {
      setLoading(true);
      setError(null);
      
      const params = {};
      
      // Add search term if provided
      if (searchTerm) {
        params.search = searchTerm;
      }
      
      // Only add location params if distance filter is applied and not 'all'
      if (selectedFilters.distance !== 'all' && location.lat && location.lng) {
        params.latitude = location.lat;
        params.longitude = location.lng;
        params.radius = selectedFilters.distance;
      }
      
      const response = await axios.get(`${import.meta.env.VITE_API_URL}/gyms`, {
        params
      });

      if (response.data.success) {
        const gymsData = response.data.data;
        setGyms(gymsData);
        
        // Find nearest gym
        findNearestGym(gymsData, location);
        
        // Extract unique options for filters
        const allAmenities = [...new Set(gymsData.flatMap(gym => gym.amenities || []))];
        const allFacilities = [...new Set(gymsData.flatMap(gym => gym.facilities || []))];
        const allServices = [...new Set(gymsData.flatMap(gym => gym.services || []))];
        
        setAmenityOptions(allAmenities.filter(Boolean));
        setFacilityOptions(allFacilities.filter(Boolean));
        setServiceOptions(allServices.filter(Boolean));
      } else {
        setError('Failed to fetch gyms');
      }
    } catch (error) {
      console.error('Error fetching gyms:', error);
      setError('Failed to load gyms. Please try again.');
    } finally {
      setLoading(false);
    }
  };

  // Check browser permissions
  const checkLocationPermission = async () => {
    if (!navigator.permissions) {
      console.log('Permissions API not supported');
      setPermissionStatus('unknown');
      return 'unknown';
    }

    try {
      const permission = await navigator.permissions.query({ name: 'geolocation' });
      console.log('Location permission status:', permission.state);
      setPermissionStatus(permission.state);
      
      permission.onchange = () => {
        console.log('Permission changed to:', permission.state);
        setPermissionStatus(permission.state);
      };
      
      return permission.state;
    } catch (error) {
      console.log('Error checking permissions:', error);
      setPermissionStatus('unknown');
      return 'unknown';
    }
  };

  // Get user's current location
  useEffect(() => {
    const detectLocation = async () => {
      // First check permissions
      const permissionState = await checkLocationPermission();
      
      if (!navigator.geolocation) {
        setLocationError('Geolocation is not supported by this browser.');
        setLocationLoading(false);
        setLocationMethod('default');
        return;
      }

      console.log('Starting location detection...');
      console.log('Browser:', navigator.userAgent);
      console.log('HTTPS:', location.protocol === 'https:');
      console.log('Permission state:', permissionState);

      // First try high accuracy GPS
      const tryHighAccuracy = () => {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              console.log('High accuracy GPS found:', {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp).toLocaleString()
              });
              resolve(position);
            },
            (error) => {
              console.log('High accuracy GPS failed:', error.message);
              reject(error);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000, // 15 seconds for GPS
              maximumAge: 60000 // 1 minute cache
            }
          );
        });
      };

      // Fallback to network-based location
      const tryNetworkLocation = () => {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              console.log('Network location found:', {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: new Date(position.timestamp).toLocaleString()
              });
              resolve(position);
            },
            (error) => {
              console.log('Network location failed:', error.message);
              reject(error);
            },
            {
              enableHighAccuracy: false,
              timeout: 10000, // 10 seconds for network
              maximumAge: 30000 // 30 seconds cache
            }
          );
        });
      };

      try {
        let position;
        
        try {
          // Try GPS first
          position = await tryHighAccuracy();
          setLocationMethod('gps');
        } catch (gpsError) {
          console.log('GPS failed, trying network location...');
          try {
            // Fallback to network
            position = await tryNetworkLocation();
            setLocationMethod('network');
          } catch (networkError) {
            throw networkError;
          }
        }

        // Check if the accuracy is very poor (more than 10km)
        if (position.coords.accuracy > 10000) {
          console.log('Very poor accuracy detected:', position.coords.accuracy + 'm');
          setLocationError(`Location detected but accuracy is very poor (Â±${Math.round(position.coords.accuracy/1000)}km). Try using "Detect GPS" button for better accuracy or set location manually.`);
          setLocationMethod('poor-gps');
        }

        setLocation({
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        });
        setLocationAccuracy(position.coords.accuracy);
        
        if (position.coords.accuracy <= 10000) {
          setLocationError(null);
        }
        setLocationLoading(false);

      } catch (error) {
        console.log('All location methods failed:', error);
        let errorMessage = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'Location access denied. Please allow location access and try again.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'Location services unavailable. Using default location.';
            break;
          case error.TIMEOUT:
            errorMessage = 'Location detection timed out. Using default location.';
            break;
          default:
            errorMessage = 'Could not detect your location. Using default location.';
            break;
        }
        setLocationError(errorMessage);
        setLocationMethod('default');
        setLocationLoading(false);
      }
    };

    detectLocation();
    fetchGyms();
  }, []);

  // Refetch when search term changes (debounced)
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      fetchGyms();
    }, 500); // Debounce search

    return () => clearTimeout(timeoutId);
  }, [searchTerm]);

  // Refetch when distance filter changes (immediate)
  useEffect(() => {
    fetchGyms();
  }, [selectedFilters.distance]);

  // Update nearest gym when location changes
  useEffect(() => {
    if (gyms.length > 0 && location) {
      findNearestGym(gyms, location);
    }
  }, [location, gyms]);

  const handleFilterChange = (filterType, value) => {
    if (filterType === "amenities" || filterType === "facilities" || filterType === "services") {
      setSelectedFilters((prev) => ({
        ...prev,
        [filterType]: prev[filterType].includes(value)
          ? prev[filterType].filter((item) => item !== value)
          : [...prev[filterType], value],
      }));
    } else {
      setSelectedFilters((prev) => ({
        ...prev,
        [filterType]: value,
      }));
    }
  };

  const handleLocationChange = (newLocation) => {
    setLocation(newLocation);
  };

  // Calculate distance between two coordinates using Haversine formula
  const calculateDistance = (lat1, lng1, lat2, lng2) => {
    const R = 6371; // Earth's radius in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // Distance in kilometers
  };

  // Find and set the nearest gym
  const findNearestGym = (gymsList, userLocation) => {
    if (!gymsList.length || !userLocation?.lat || !userLocation?.lng) {
      setNearestGymId(null);
      return;
    }

    let nearestGym = null;
    let shortestDistance = Infinity;

    gymsList.forEach(gym => {
      if (gym.location?.coordinates && gym.location.coordinates.length === 2) {
        const [gymLng, gymLat] = gym.location.coordinates;
        const distance = calculateDistance(
          userLocation.lat, 
          userLocation.lng, 
          gymLat, 
          gymLng
        );
        
        if (distance < shortestDistance) {
          shortestDistance = distance;
          nearestGym = gym;
        }
      }
    });

    if (nearestGym) {
      setNearestGymId(nearestGym._id);
      console.log(`Nearest gym: ${nearestGym.gymName} (${shortestDistance.toFixed(2)} km away)`);
    } else {
      setNearestGymId(null);
    }
  };

  const getCurrentLocation = async () => {
    setLocationLoading(true);
    setLocationError(null);
    
    if (!navigator.geolocation) {
      setLocationError('Geolocation is not supported by this browser.');
      setLocationLoading(false);
      return;
    }

    console.log('Manual location detection started with accuracy improvement...');

    // High accuracy GPS with longer timeout
    const tryPreciseGPS = () => {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log('Manual high accuracy GPS:', {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy + 'm',
              speed: position.coords.speed,
              heading: position.coords.heading,
              timestamp: new Date(position.timestamp).toLocaleString()
            });
            resolve(position);
          },
          (error) => {
            console.log('Manual high accuracy failed:', error.message);
            reject(error);
          },
          {
            enableHighAccuracy: true,
            timeout: 20000, // 20 seconds for manual GPS
            maximumAge: 0 // Force fresh location
          }
        );
      });
    };

    // Fallback to network location
    const tryQuickLocation = () => {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log('Manual network location:', {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy + 'm',
              timestamp: new Date(position.timestamp).toLocaleString()
            });
            resolve(position);
          },
          (error) => {
            console.log('Manual network location failed:', error.message);
            reject(error);
          },
          {
            enableHighAccuracy: false,
            timeout: 10000,
            maximumAge: 0 // Force fresh location
          }
        );
      });
    };

    try {
      let bestPosition = null;
      let attempts = 0;
      const maxAttempts = 3;

      // Try multiple times to get better accuracy
      while (attempts < maxAttempts && (!bestPosition || bestPosition.coords.accuracy > 1000)) {
        attempts++;
        console.log(`Attempt ${attempts}/${maxAttempts} for better location accuracy...`);
        
        try {
          const position = await tryPreciseGPS();
          console.log(`Attempt ${attempts} accuracy: ${position.coords.accuracy}m`);
          
          if (!bestPosition || position.coords.accuracy < bestPosition.coords.accuracy) {
            bestPosition = position;
            console.log(`New best accuracy: ${position.coords.accuracy}m`);
          }
          
          // Stop if we get good accuracy (under 100m)
          if (position.coords.accuracy < 100) {
            console.log('Good accuracy achieved, stopping attempts');
            break;
          }
          
          // Wait 1 second between attempts
          if (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
          
        } catch (error) {
          console.log(`Attempt ${attempts} failed:`, error.message);
        }
      }

      // If we don't have a good GPS position, try network
      if (!bestPosition || bestPosition.coords.accuracy > 5000) {
        console.log('GPS accuracy still poor, trying network location...');
        try {
          const networkPosition = await tryQuickLocation();
          if (!bestPosition || networkPosition.coords.accuracy < bestPosition.coords.accuracy) {
            bestPosition = networkPosition;
            setLocationMethod('network');
          } else {
            setLocationMethod('gps');
          }
        } catch (networkError) {
          if (!bestPosition) {
            throw networkError;
          }
          setLocationMethod('gps');
        }
      } else {
        setLocationMethod('gps');
      }

      if (!bestPosition) {
        throw new Error('No location obtained');
      }

      console.log('Final location accuracy:', bestPosition.coords.accuracy + 'm');

      // Warn if accuracy is still poor
      if (bestPosition.coords.accuracy > 10000) {
        setLocationError(`Location detected but accuracy is very poor (Â±${Math.round(bestPosition.coords.accuracy/1000)}km). Consider using manual location input for better results.`);
      } else if (bestPosition.coords.accuracy > 1000) {
        setLocationError(`Location accuracy is moderate (Â±${Math.round(bestPosition.coords.accuracy)}m). For better results, try again when you have better GPS signal.`);
      } else {
        setLocationError(null);
      }

      setLocation({
        lat: bestPosition.coords.latitude,
        lng: bestPosition.coords.longitude,
      });
      setLocationAccuracy(bestPosition.coords.accuracy);
      setLocationLoading(false);

    } catch (error) {
      console.log('All manual location methods failed:', error);
      let errorMessage = 'Failed to detect your current location. ';
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage += 'Please allow location access in your browser settings.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage += 'Your device location services may be disabled.';
          break;
        case error.TIMEOUT:
          errorMessage += 'Location detection took too long. Try again or use manual input.';
          break;
        default:
          errorMessage += 'Please try again or enter your location manually.';
          break;
      }
      setLocationError(errorMessage);
      setLocationLoading(false);
    }
  };

  const handleManualLocationSubmit = () => {
    const lat = parseFloat(manualLocationInput.lat);
    const lng = parseFloat(manualLocationInput.lng);
    
    if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
      alert('Please enter valid coordinates (Latitude: -90 to 90, Longitude: -180 to 180)');
      return;
    }
    
    setLocation({ lat, lng });
    setLocationMethod('manual');
    setLocationError(null);
    setShowManualLocationModal(false);
    setManualLocationInput({ lat: '', lng: '' });
  };

  const getPriceRange = (gym) => {
    if (!gym.pricing?.membershipPlans || gym.pricing.membershipPlans.length === 0) {
      return "budget";
    }
    
    const avgPrice = gym.pricing.membershipPlans.reduce((acc, plan) => acc + (plan.price || 0), 0) / gym.pricing.membershipPlans.length;
    
    if (avgPrice < 3000) return "budget";
    if (avgPrice <= 5000) return "standard";
    return "premium";
  };

  const filteredGyms = gyms.filter((gym) => {
    const matchesSearch = !searchTerm || 
      gym.gymName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      gym.address?.city?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      gym.description?.toLowerCase().includes(searchTerm.toLowerCase());

    const matchesPriceRange = selectedFilters.priceRange === "all" || 
      getPriceRange(gym) === selectedFilters.priceRange;

    const matchesRating = selectedFilters.rating === "all" || 
      (gym.rating?.average >= parseFloat(selectedFilters.rating));

    const matchesAmenities = selectedFilters.amenities.length === 0 ||
      selectedFilters.amenities.every((amenity) =>
        gym.amenities?.includes(amenity)
      );

    const matchesFacilities = selectedFilters.facilities.length === 0 ||
      selectedFilters.facilities.every((facility) =>
        gym.facilities?.includes(facility)
      );

    const matchesServices = selectedFilters.services.length === 0 ||
      selectedFilters.services.every((service) =>
        gym.services?.includes(service)
      );

    return matchesSearch && matchesPriceRange && matchesRating && 
           matchesAmenities && matchesFacilities && matchesServices;
  }).map(gym => {
    // Add distance to each gym
    const distance = gym.location?.coordinates ? 
      calculateDistance(
        location.lat, 
        location.lng, 
        gym.location.coordinates[1], 
        gym.location.coordinates[0]
      ) : null;
    
    return {
      ...gym,
      distanceFromUser: distance
    };
  }).sort((a, b) => {
    // Sort by distance (nearest first), then by name
    if (a.distanceFromUser === null && b.distanceFromUser === null) return 0;
    if (a.distanceFromUser === null) return 1;
    if (b.distanceFromUser === null) return -1;
    return a.distanceFromUser - b.distanceFromUser;
  });

  const getDisplayImage = (gym) => {
    if (gym.images && gym.images.length > 0) {
      const primaryImage = gym.images.find(img => img.isPrimary);
      return primaryImage ? primaryImage.url : gym.images[0].url;
    }
    if (gym.logo?.url) {
      return gym.logo.url;
    }
    return "https://images.unsplash.com/photo-1534438327276-14e5300c3a48?auto=format&fit=crop&q=80";
  };

  const formatOperatingHours = (operatingHours) => {
    if (!operatingHours) return "Hours not specified";
    
    const today = new Date().toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
    const todayHours = operatingHours[today];
    
    if (todayHours?.closed) return "Closed today";
    if (todayHours?.open && todayHours?.close) {
      return `${todayHours.open} - ${todayHours.close}`;
    }
    return "Hours not specified";
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-900 pt-24 pb-12 relative overflow-hidden">
        <div className="container mx-auto px-4 relative">
          <div className="flex items-center justify-center h-64">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-500"></div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-900 pt-24 pb-12 relative overflow-hidden">
      {/* Background Effects */}
      <div className="absolute inset-0">
        <div className="absolute inset-0 bg-gradient-to-br from-violet-900/20 via-gray-900/50 to-indigo-900/20"></div>
        <div className="absolute top-0 left-0 w-full h-full overflow-hidden">
          {[...Array(20)].map((_, i) => (
            <div
              key={i}
              className="absolute bg-gradient-to-br from-violet-500/5 to-indigo-500/5 rounded-full animate-float"
              style={{
                width: Math.random() * 300 + 50 + "px",
                height: Math.random() * 300 + 50 + "px",
                top: Math.random() * 100 + "%",
                left: Math.random() * 100 + "%",
                animationDelay: `${Math.random() * 5}s`,
                animationDuration: `${Math.random() * 10 + 10}s`,
              }}
            />
          ))}
        </div>
      </div>

      <div className="container mx-auto px-4 relative">
        {/* Back Button */}
        <Link
          to="/"
          className="inline-flex items-center text-gray-400 hover:text-white mb-8 group transition-colors"
        >
          <FiArrowLeft className="mr-2 group-hover:-translate-x-1 transition-transform" />
          Back to Home
        </Link>

        {/* Header */}
        <div className="max-w-4xl mx-auto text-center mb-12">
          <h1 className="text-5xl font-bold mb-6 bg-gradient-to-r from-violet-400 to-indigo-400 bg-clip-text text-transparent">
            Find Your Perfect Gym
          </h1>
          <p className="text-xl text-gray-400">
            Discover top-rated gyms and fitness centers near you. Filter by
            amenities, read reviews, and find the perfect fit for your fitness
            journey.
          </p>
        </div>

        {/* Location Status and Search Bar */}
        <div className="max-w-3xl mx-auto mb-12 space-y-4">
          {/* Location Status */}
          <div className="bg-gray-800/40 backdrop-blur-xl rounded-lg p-4 border border-gray-700/50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className={`w-3 h-3 rounded-full ${
                  locationMethod === 'gps' ? (locationAccuracy && locationAccuracy < 1000 ? 'bg-green-500' : 'bg-orange-500') : 
                  locationMethod === 'poor-gps' ? 'bg-red-500' :
                  locationMethod === 'network' ? 'bg-blue-500' :
                  locationMethod === 'default' ? 'bg-yellow-500' : 'bg-purple-500'
                }`}></div>
                <div>
                  <div className="text-white font-medium">
                    {locationMethod === 'gps' ? 
                      (locationAccuracy && locationAccuracy < 1000 ? 'GPS Location Detected (High Accuracy)' : 'GPS Location Detected (Low Accuracy)') : 
                     locationMethod === 'poor-gps' ? 'GPS Location Detected (Very Poor Accuracy)' :
                     locationMethod === 'network' ? 'Network Location Detected' :
                     locationMethod === 'default' ? 'Using Default Location (Colombo)' : 'Manual Location Set'}
                  </div>
                  <div className="text-gray-400 text-sm">
                    {locationError ? locationError : 
                     `Lat: ${location.lat.toFixed(6)}, Lng: ${location.lng.toFixed(6)}`}
                    {locationAccuracy && !locationError && (
                      <div className="text-xs text-gray-500 mt-1">
                        Accuracy: Â±{Math.round(locationAccuracy)}m â€¢ Permission: {permissionStatus}
                      </div>
                    )}
                  </div>
                </div>
              </div>
              <div className="flex space-x-2">
                <button
                  onClick={getCurrentLocation}
                  disabled={locationLoading}
                  className="bg-violet-600/20 text-violet-400 border border-violet-500/30 px-3 py-2 rounded-lg hover:bg-violet-600/30 transition-colors flex items-center disabled:opacity-50"
                >
                  {locationLoading ? (
                    <div className="w-4 h-4 border-2 border-violet-400 border-t-transparent rounded-full animate-spin mr-2"></div>
                  ) : (
                    <FiNavigation className="w-4 h-4 mr-2" />
                  )}
                  Detect GPS
                </button>
                <button
                  onClick={() => setShowManualLocationModal(true)}
                  className="bg-gray-600/20 text-gray-400 border border-gray-500/30 px-3 py-2 rounded-lg hover:bg-gray-600/30 transition-colors flex items-center"
                >
                  <FiMapPin className="w-4 h-4 mr-2" />
                  Manual
                </button>
              </div>
            </div>
          </div>

          {/* Debug Information & Recommendations */}
          <div className="bg-gray-800/20 backdrop-blur-xl rounded-lg p-3 border border-gray-700/30 text-xs">
            <div className="text-gray-300 font-medium mb-2">Debug Information & Recommendations:</div>
            <div className="grid grid-cols-2 gap-4 text-gray-400 mb-3">
              <div>Browser Supports GPS: {navigator.geolocation ? 'âœ… Yes' : 'âŒ No'}</div>
              <div>HTTPS Connection: {window.location.protocol === 'https:' ? 'âœ… Yes' : 'âŒ No'}</div>
              <div>Permission Status: {permissionStatus}</div>
              <div>Location Method: {locationMethod}</div>
              <div>Current Accuracy: {locationAccuracy ? `Â±${Math.round(locationAccuracy)}m` : 'N/A'}</div>
              <div>Loading: {locationLoading ? 'â³ Yes' : 'âœ… No'}</div>
            </div>
            
            {/* Accuracy Warning */}
            {locationAccuracy && locationAccuracy > 10000 && (
              <div className="bg-red-900/20 border border-red-500/30 rounded-lg p-2 mb-2">
                <div className="text-red-400 font-medium mb-1">âš ï¸ Very Poor Location Accuracy</div>
                <div className="text-red-300 text-xs">
                  Your location accuracy is Â±{Math.round(locationAccuracy/1000)}km. This means gym distances may be very inaccurate.
                </div>
              </div>
            )}
            
            {/* HTTPS Recommendation */}
            {window.location.protocol !== 'https:' && (
              <div className="bg-yellow-900/20 border border-yellow-500/30 rounded-lg p-2 mb-2">
                <div className="text-yellow-400 font-medium mb-1">ðŸ’¡ Recommendation</div>
                <div className="text-yellow-300 text-xs">
                  Use HTTPS for better location accuracy. HTTP connections may limit GPS precision.
                </div>
              </div>
            )}

            <div className="text-xs text-gray-500">
              ðŸ’¡ Tip: Try the "Detect GPS" button for better accuracy, or use "Manual" to set your exact location
            </div>
          </div>

          {/* Search Bar */}
          <div className="flex items-center gap-4 bg-gray-800/40 backdrop-blur-xl p-2 rounded-full border border-gray-700/50">
            <div className="flex-1 relative">
              <FiSearch className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" />
              <input
                type="text"
                placeholder="Search by location or gym name..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full bg-transparent text-white pl-12 pr-4 py-3 focus:outline-none"
              />
            </div>
            <button 
              onClick={fetchGyms}
              className="bg-violet-600 text-white px-6 py-3 rounded-full hover:bg-violet-700 transition-colors flex items-center"
            >
              <FiRefreshCw className="w-4 h-4 mr-2" />
              Search
            </button>
          </div>
        </div>

        {error && (
          <div className="max-w-3xl mx-auto mb-8">
            <div className="bg-red-900/20 border border-red-500/50 rounded-lg p-4 flex items-center">
              <FiAlertCircle className="w-5 h-5 text-red-400 mr-3" />
              <span className="text-red-300">{error}</span>
              <button 
                onClick={fetchGyms}
                className="ml-auto text-red-400 hover:text-red-300"
              >
                Retry
              </button>
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Filters */}
          <div className="space-y-6">
            <div className="bg-gray-800/40 backdrop-blur-xl rounded-xl p-6 border border-gray-700/50">
              <h2 className="text-xl font-semibold text-white mb-4 flex items-center">
                <FiFilter className="mr-2" /> Filters
              </h2>
              
              {/* Price Range */}
              <div className="mb-6">
                <h3 className="text-gray-300 font-medium mb-3">Price Range</h3>
                <select
                  value={selectedFilters.priceRange}
                  onChange={(e) => handleFilterChange("priceRange", e.target.value)}
                  className="w-full bg-gray-900/50 text-white rounded-lg px-4 py-2 border border-gray-700/50 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none"
                >
                  {priceRangeOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Rating */}
              <div className="mb-6">
                <h3 className="text-gray-300 font-medium mb-3">Rating</h3>
                <select
                  value={selectedFilters.rating}
                  onChange={(e) => handleFilterChange("rating", e.target.value)}
                  className="w-full bg-gray-900/50 text-white rounded-lg px-4 py-2 border border-gray-700/50 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none"
                >
                  {ratingOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Distance */}
              <div className="mb-6">
                <h3 className="text-gray-300 font-medium mb-3">Distance</h3>
                <select
                  value={selectedFilters.distance}
                  onChange={(e) => handleFilterChange("distance", e.target.value)}
                  className="w-full bg-gray-900/50 text-white rounded-lg px-4 py-2 border border-gray-700/50 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none"
                >
                  {distanceOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              {/* Facilities */}
              {facilityOptions.length > 0 && (
                <div className="mb-6">
                  <h3 className="text-gray-300 font-medium mb-3">Facilities</h3>
                  <div className="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">
                    {facilityOptions.map((facility) => (
                      <label
                        key={facility}
                        className="flex items-center space-x-2 text-sm cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          checked={selectedFilters.facilities.includes(facility)}
                          onChange={() => handleFilterChange("facilities", facility)}
                          className="hidden"
                        />
                        <div
                          className={`w-4 h-4 rounded border flex items-center justify-center ${
                            selectedFilters.facilities.includes(facility)
                              ? "bg-violet-500 border-violet-500"
                              : "border-gray-600"
                          }`}
                        >
                          {selectedFilters.facilities.includes(facility) && (
                            <FiCheck className="w-3 h-3 text-white" />
                          )}
                        </div>
                        <span className="text-gray-400">{facility}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}

              {/* Services */}
              {serviceOptions.length > 0 && (
                <div className="mb-6">
                  <h3 className="text-gray-300 font-medium mb-3">Services</h3>
                  <div className="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">
                    {serviceOptions.map((service) => (
                      <label
                        key={service}
                        className="flex items-center space-x-2 text-sm cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          checked={selectedFilters.services.includes(service)}
                          onChange={() => handleFilterChange("services", service)}
                          className="hidden"
                        />
                        <div
                          className={`w-4 h-4 rounded border flex items-center justify-center ${
                            selectedFilters.services.includes(service)
                              ? "bg-violet-500 border-violet-500"
                              : "border-gray-600"
                          }`}
                        >
                          {selectedFilters.services.includes(service) && (
                            <FiCheck className="w-3 h-3 text-white" />
                          )}
                        </div>
                        <span className="text-gray-400">{service}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}

              {/* Amenities */}
              {amenityOptions.length > 0 && (
                <div>
                  <h3 className="text-gray-300 font-medium mb-3">Amenities</h3>
                  <div className="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">
                    {amenityOptions.map((amenity) => (
                      <label
                        key={amenity}
                        className="flex items-center space-x-2 text-sm cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          checked={selectedFilters.amenities.includes(amenity)}
                          onChange={() => handleFilterChange("amenities", amenity)}
                          className="hidden"
                        />
                        <div
                          className={`w-4 h-4 rounded border flex items-center justify-center ${
                            selectedFilters.amenities.includes(amenity)
                              ? "bg-violet-500 border-violet-500"
                              : "border-gray-600"
                          }`}
                        >
                          {selectedFilters.amenities.includes(amenity) && (
                            <FiCheck className="w-3 h-3 text-white" />
                          )}
                        </div>
                        <span className="text-gray-400">{amenity}</span>
                      </label>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Map */}
            <div className="bg-gray-800/40 backdrop-blur-xl rounded-xl overflow-hidden border border-gray-700/50">
              <div className="p-4 border-b border-gray-700/50 flex items-center justify-between">
                <h3 className="text-white font-medium">Gym Locations</h3>
                <button
                  onClick={getCurrentLocation}
                  disabled={locationLoading}
                  className="flex items-center px-3 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                >
                  <FiNavigation className={`w-4 h-4 mr-2 ${locationLoading ? 'animate-spin' : ''}`} />
                  {locationLoading ? 'Getting Location...' : 'Use My Location'}
                </button>
              </div>
              <div className="h-[400px]">
                <MapComponent
                  location={location}
                  onLocationChange={handleLocationChange}
                  gyms={filteredGyms}
                />
              </div>
              <div className="p-3 bg-gray-900/50 text-xs text-gray-400 text-center">
                Current Location: {location.lat.toFixed(4)}, {location.lng.toFixed(4)}
              </div>
            </div>
          </div>

          {/* Gym Listings */}
          <div className="lg:col-span-2 space-y-6">
            {filteredGyms.map((gym, index) => {
              const isNearestGym = index === 0 && gym.distanceFromUser !== null; // First gym is nearest
              const distance = gym.distanceFromUser?.toFixed(1);

              return (
                <div
                  key={gym._id}
                  className={`bg-gray-800/40 backdrop-blur-xl rounded-xl overflow-hidden border transition-all duration-300 ${
                    isNearestGym 
                      ? 'border-violet-500/80 shadow-[0_0_40px_rgba(124,58,237,0.5)] ring-2 ring-violet-500/40 transform scale-[1.02]' 
                      : 'border-gray-700/50 hover:shadow-[0_0_30px_rgba(124,58,237,0.2)]'
                  }`}
                >
                  {/* Distance Badge - Show for all gyms */}
                  <div className={`px-4 py-2 text-sm font-medium flex items-center justify-between ${
                    isNearestGym 
                      ? 'bg-gradient-to-r from-violet-600 to-purple-600 text-white'
                      : 'bg-gray-700/50 text-gray-300'
                  }`}>
                    <div className="flex items-center">
                      {isNearestGym && <FiNavigation className="w-4 h-4 mr-2" />}
                      <span>
                        {isNearestGym ? 'Closest Gym to You' : 'Distance from you'}
                      </span>
                    </div>
                    <div className="flex items-center">
                      <FiMapPin className="w-4 h-4 mr-1" />
                      <span className="font-semibold">
                        {distance ? `${distance} km` : 'Location N/A'}
                      </span>
                    </div>
                  </div>
              
                <div className="flex flex-col md:flex-row">
                  {/* Gym Image */}
                  <div className="md:w-64 h-48 md:h-auto relative overflow-hidden">
                    <img
                      src={getDisplayImage(gym)}
                      alt={gym.gymName}
                      className="w-full h-full object-cover transform hover:scale-110 transition-transform duration-500"
                    />
                    {gym.status !== 'approved' && (
                      <div className="absolute top-2 left-2 px-2 py-1 bg-yellow-500/90 text-black text-xs rounded">
                        {gym.status}
                      </div>
                    )}
                  </div>

                  {/* Gym Details */}
                  <div className="flex-1 p-6">
                    <div className="flex items-start justify-between mb-4">
                      <div>
                        <h3 className="text-2xl font-semibold text-white mb-2">
                          {gym.gymName}
                        </h3>
                        <div className="flex items-center text-gray-400 text-sm">
                          <FiMapPin className="w-4 h-4 mr-1" />
                          <span>{gym.address?.city}, {gym.address?.state}</span>
                        </div>
                      </div>
                      <div className="flex items-center">
                        <div className="text-yellow-400 mr-2">
                          <FiStar className="w-5 h-5 inline-block" />
                        </div>
                        <div>
                          <div className="text-white font-semibold">
                            {gym.rating?.average ? gym.rating.average.toFixed(1) : 'N/A'}
                          </div>
                          <div className="text-gray-400 text-sm">
                            {gym.rating?.totalReviews || 0} reviews
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                      <div className="flex items-center text-gray-400">
                        <FiClock className="w-4 h-4 mr-2 text-violet-400" />
                        <span className="text-sm">{formatOperatingHours(gym.operatingHours)}</span>
                      </div>
                      <div className="flex items-center text-gray-400">
                        <FiUsers className="w-4 h-4 mr-2 text-violet-400" />
                        <span className="text-sm">
                          {gym.capacity} capacity
                        </span>
                      </div>
                      <div className="flex items-center text-gray-400">
                        <FiDollarSign className="w-4 h-4 mr-2 text-violet-400" />
                        <span className="text-sm capitalize">{getPriceRange(gym)}</span>
                      </div>
                      <div className="flex items-center text-gray-400">
                        <FiActivity className="w-4 h-4 mr-2 text-violet-400" />
                        <span className="text-sm">
                          {(gym.facilities?.length || 0) + (gym.services?.length || 0)} features
                        </span>
                      </div>
                    </div>
                    
                    <div className="flex flex-wrap gap-2 mb-4">
                      {gym.facilities?.slice(0, 3).map((facility, index) => (
                        <span
                          key={index}
                          className="px-3 py-1 bg-blue-500/10 text-blue-400 rounded-full text-sm"
                        >
                          {facility}
                        </span>
                      ))}
                      {gym.services?.slice(0, 2).map((service, index) => (
                        <span
                          key={index}
                          className="px-3 py-1 bg-green-500/10 text-green-400 rounded-full text-sm"
                        >
                          {service}
                        </span>
                      ))}
                      {((gym.facilities?.length || 0) + (gym.services?.length || 0)) > 5 && (
                        <span className="px-3 py-1 bg-gray-700/50 text-gray-300 rounded-full text-sm">
                          +{((gym.facilities?.length || 0) + (gym.services?.length || 0)) - 5} more
                        </span>
                      )}
                    </div>
                    
                    <div className="mt-6 flex flex-wrap gap-4">
                      <button
                        onClick={() =>
                          setSelectedGym(selectedGym === gym._id ? null : gym._id)
                        }
                        className="flex items-center px-4 py-2 bg-violet-600/20 text-violet-400 rounded-lg hover:bg-violet-600/30 transition-colors"
                      >
                        View Details
                        <FiChevronDown
                          className={`ml-2 transform transition-transform ${
                            selectedGym === gym._id ? "rotate-180" : ""
                          }`}
                        />
                      </button>
                      <Link
                        to={`/customer-register-gym/${gym._id}`}
                        className="flex items-center px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors"
                      >
                        Join Now
                        <FiArrowRight className="ml-2" />
                      </Link>
                    </div>
                  </div>
                </div>

                {/* Render GymDetails component when expanded */}
                {selectedGym === gym._id && <GymDetails gym={gym} />}
              </div>
              );
            })}

            {/* No Results Message */}
            {filteredGyms.length === 0 && !loading && (
              <div className="text-center py-12 bg-gray-800/40 backdrop-blur-xl rounded-xl border border-gray-700/50">
                <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-violet-500/10 mb-4">
                  <FiSearch className="w-8 h-8 text-violet-400" />
                </div>
                <h3 className="text-xl font-semibold text-white mb-2">
                  No Gyms Found
                </h3>
                <p className="text-gray-400 mb-4">
                  Try adjusting your filters or search criteria
                </p>
                <button 
                  onClick={fetchGyms}
                  className="px-4 py-2 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors"
                >
                  Refresh Results
                </button>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Manual Location Modal */}
      {showManualLocationModal && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-gray-800 rounded-xl p-6 w-full max-w-md border border-gray-700">
            <div className="flex items-center justify-between mb-6">
              <h3 className="text-xl font-semibold text-white">Set Manual Location</h3>
              <button
                onClick={() => {
                  setShowManualLocationModal(false);
                  setManualLocationInput({ lat: '', lng: '' });
                }}
                className="text-gray-400 hover:text-white transition-colors"
              >
                <FiX className="w-5 h-5" />
              </button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-gray-300 text-sm font-medium mb-2">
                  Latitude
                </label>
                <input
                  type="number"
                  step="any"
                  placeholder="e.g., 6.9271"
                  value={manualLocationInput.lat}
                  onChange={(e) => setManualLocationInput(prev => ({ ...prev, lat: e.target.value }))}
                  className="w-full bg-gray-900/50 text-white rounded-lg px-4 py-3 border border-gray-700/50 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none"
                />
              </div>
              
              <div>
                <label className="block text-gray-300 text-sm font-medium mb-2">
                  Longitude
                </label>
                <input
                  type="number"
                  step="any"
                  placeholder="e.g., 79.8612"
                  value={manualLocationInput.lng}
                  onChange={(e) => setManualLocationInput(prev => ({ ...prev, lng: e.target.value }))}
                  className="w-full bg-gray-900/50 text-white rounded-lg px-4 py-3 border border-gray-700/50 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none"
                />
              </div>
              
              <div className="bg-gray-700/30 rounded-lg p-3 text-sm text-gray-400">
                <div className="font-medium text-white mb-1">Popular Sri Lankan Cities:</div>
                <div className="space-y-1">
                  <button
                    onClick={() => setManualLocationInput({ lat: '6.9271', lng: '79.8612' })}
                    className="block hover:text-violet-400 transition-colors"
                  >
                    Colombo: 6.9271, 79.8612
                  </button>
                  <button
                    onClick={() => setManualLocationInput({ lat: '7.2906', lng: '80.6337' })}
                    className="block hover:text-violet-400 transition-colors"
                  >
                    Kandy: 7.2906, 80.6337
                  </button>
                  <button
                    onClick={() => setManualLocationInput({ lat: '6.0535', lng: '80.2210' })}
                    className="block hover:text-violet-400 transition-colors"
                  >
                    Galle: 6.0535, 80.2210
                  </button>
                </div>
              </div>
            </div>
            
            <div className="flex space-x-3 mt-6">
              <button
                onClick={() => {
                  setShowManualLocationModal(false);
                  setManualLocationInput({ lat: '', lng: '' });
                }}
                className="flex-1 px-4 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition-colors"
              >
                Cancel
              </button>
              <button
                onClick={handleManualLocationSubmit}
                className="flex-1 px-4 py-3 bg-violet-600 text-white rounded-lg hover:bg-violet-700 transition-colors"
              >
                Set Location
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default FindGym;